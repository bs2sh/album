const admin = require("firebase-admin");

// 키파일 경로
const serviceAccount = require("./serviceAccountKey.json");

// firebase admin 초기화
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

// 1개만 발송.
async function sendSingleMsg(token, title, body, additionalInfo) {
  const message = {
    notification: {
      title: title,
      body: body,
    },

    data: additionalInfo,

    token: token,
  };
  try {
    const response = await admin.messaging().send(message);
    console.log("메시지 전송 OK:", response);
  } catch (error) {
    console.log("메시지 전송 FAIL:", error);
  }
}

// 여러개 발송.
async function sendMultiMsg(tokens, title, body, additionalInfo) {
  const message = {
    notification: {
      title: title,
      body: body,
    },

    data: additionalInfo,

    tokens: tokens,
  };
  try {
    // sendEachForMulticast는 여러 개의 메시지를 안전하게 보냅니다.
    const response = await admin.messaging().sendEachForMulticast(message);
    console.log(
      `성공: ${response.successCount}건, 실패: ${response.failureCount}건`
    );

    // 실패한 토큰이 있다면 확인 (앱 삭제 등으로 유효하지 않게 된 토큰 처리)
    if (response.failureCount > 0) {
      const failedTokens = [];
      response.responses.forEach((resp, idx) => {
        if (!resp.success) {
          failedTokens.push(targetTokens[idx]);
        }
      });
      console.log("실패한 토큰들:", failedTokens);
    }
  } catch (error) {
    console.error("단체 전송 실패:", error);
  }
}

module.exports = { sendSingleMsg, sendMultiMsg };
